# This .travis.yml on:
# https://github.com/loot/loot/blob/dev/.travis.yml
# https://genbattle.bitbucket.io/blog/2016/01/17/c++-travis-ci/?
 
language: cpp
dist: trusty

cache:
  directories:
    # Cache the boost install
    - $HOME/boost_1_63_0/boost
    - $HOME/boost_1_63_0/stage/lib
    
addons:
  apt:
    sources: &default_sources
      - ubuntu-toolchain-r-test
    packages: &default_packages
      - libboost-all-dev
      - libhdf5-dev

matrix:
  include:
   
    - os: linux
      compiler: gcc
      env: CXX_COMPILER_NAME='g++-6'
      addons:
        apt:
          sources:  [*default_sources]
          packages: [*default_packages, g++-6]

    - os: linux
      compiler: clang
      env: CXX_COMPILER_NAME='clang++-3.8'
      addons:
        apt:
          sources:  [*default_sources, llvm-toolchain-trusty]
          packages: [*default_packages, clang++-3.8, libstdc++-6-dev]

    - os: linux
      compiler: clang
      env: CXX_COMPILER_NAME='clang++-4.0'
      addons:
        apt:
          sources:  [*default_sources, llvm-toolchain-trusty-4.0]
          packages: [*default_packages, clang++-4.0, libstdc++-6-dev]

    - os: osx
      osx_image: xcode8.3
      compiler: clang
      env: CXX_COMPILER_NAME='c++' CLANGSOURCE=APPLE
       
    - os: osx
      osx_image: xcode8.3
      compiler: clang
      env: CXX_COMPILER_NAME='/usr/local/bin/clang++-3.8' CLANGSOURCE=LLVM

before_install:
  # Check commit matches expected commit (because of Travis bug)
  - if [[ "$TRAVIS_COMMIT" != "$(git rev-parse HEAD)" ]]; then echo "Commit $(git rev-parse HEAD) doesn't match expected commit $TRAVIS_COMMIT"; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]] && [[ "$CLANGSOURCE" == "LLVM" ]]; then brew update && brew install --with-clang llvm38 && brew link --force --overwrite llvm38; fi
  # This needs to be done because we want to override Travis's definitions of CC and CXX that lead to old Ubuntu-packaged compilers
  - export CXX="$CXX_COMPILER_NAME"
  # Build and install boost.
  - echo "using mpi ;" > ~/site-config.jam
  - python src/resources/travis/install_boost.py --directory ~ --boost-version 1.63.0 --address-model 64 --toolchain=$CXX --stagedir stage atomic chrono date_time filesystem iostreams locale log regex system thread serialization mpi
  # Set the BOOST_ROOT environment variable.
  - export BOOST_ROOT=$HOME/boost_1_63_0
  - if [ $TRAVIS_OS_NAME == "osx" ]; then sudo cp $HOME/boost_1_63_0/stage/lib/* /usr/local/lib/; else export LD_LIBRARY_PATH=$HOME/boost_1_63_0/stage/lib:$LD_LIBRARY_PATH; fi
  

script:
  - PARALLEL_MAKE=-j2 make install
  - make test
